<?php
ob_start(); // Prevent TCPDF errors due to prior output

require_once('../TCPDF-main/tcpdf.php');
include '../connection.php';
include '../session_check.php';

// Get user
$user_id = $_SESSION['user'];

// Check attendance
$total_sessions = 1;
$sql = "SELECT COUNT(*) AS present_days FROM attendances WHERE user_id = ? AND status = 'Present'";
$stmt = $conn->prepare($sql);
$stmt->bind_param("i", $user_id);
$stmt->execute();
$result = $stmt->get_result();
$row = $result->fetch_assoc();
$present_days = $row['present_days'];
$attendance_percentage = ($present_days / $total_sessions) * 100;

if ($attendance_percentage < 75) {
    header("Location: not_eligible.php");
    exit;
}

// Get name and date
$sql2 = "SELECT full_name FROM users WHERE user_id = ?";
$stmt2 = $conn->prepare($sql2);
$stmt2->bind_param("i", $user_id);
$stmt2->execute();
$result2 = $stmt2->get_result();
$user = $result2->fetch_assoc();
$full_name = strtoupper($user['full_name']);
$completion_date = date("F j, Y");

// === PDF Setup ===
$pdf = new TCPDF('L', 'mm', 'A3', true, 'UTF-8', false);
$pdf->SetCreator('SMART NDOA SYSTEM');
$pdf->SetAuthor('Mufti Office Zanzibar');
$pdf->SetTitle('Marriage Ethics Certificate');

// Remove margins for perfect border
$pdf->SetMargins(0, 0, 0);
$pdf->AddPage();

// Draw Green Border (equal all sides)
$pdf->SetDrawColor(0, 128, 0); // Dark green
$pdf->SetLineWidth(1);
$pdf->Rect(10, 10, 400, 277); // Perfect within A3

// === Logo (colorful logo image must be used) ===
$pdf->Image('../logo/logo.jpg', 185, 25, 50); // Centered

// === Title ===
$pdf->Ln(65);
$pdf->SetFont('times', 'B', 28);
$pdf->SetTextColor(0, 0, 0);
$pdf->Cell(0, 15, "THE GRAND MUFTI'S OFFICE OF ZANZIBAR", 0, 1, 'C');

$pdf->SetFont('times', 'B', 26);
$pdf->Cell(0, 15, 'CERTIFICATE OF COMPLETION', 0, 1, 'C');

// âœ… Add green underline after title
$pdf->SetDrawColor(0, 128, 0);
$pdf->SetLineWidth(0.6);
$pdf->Line(70, $pdf->GetY(), 370, $pdf->GetY()); // Spaced in from edges
$pdf->Ln(1);

// === Body Content ===
$pdf->SetFont('times', '', 20);
$pdf->SetTextColor(0, 0, 0); // Black for normal text

$html = "
<div style=\"text-align: center;\">
    This is to certify that<br><br>
    <span style=\"font-size: 30px;\"><b>$full_name</b></span><br><br>
    has successfully completed the<br><br>
    <span style=\"font-size:24px; color:rgb(0,128,0);\"><b>Marriage Ethics Training</b></span><br><br>
    conducted by the Office of the Mufti as part of the official marriage preparation program.
</div>";
$pdf->writeHTML($html, true, false, true, false, '');

$pdf->Ln(10);

// Completion Date
$pdf->SetFont('times', 'B', 18);
$pdf->SetTextColor(0, 0, 0);
$pdf->Cell(0, 10, "Completion Date: $completion_date", 0, 1, 'C');

// === Signature Section (right bottom) ===
$pdf->SetY(240);
$pdf->Image('../images/signature.png', 330, 240, 50); // Inside border

$pdf->SetY(262);
$pdf->SetFont('times', '', 14);
$pdf->Cell(0, 10, 'Signature - Office of the Mufti', 0, 0, 'R');

// === Output PDF ===
ob_end_clean();
$pdf->Output("Certificate_$full_name.pdf", 'D');
exit;
?>
